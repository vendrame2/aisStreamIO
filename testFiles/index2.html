<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotas Marítimas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #mapid { height: 600px; width: 100%; }
    </style>
</head>
<body>
    <h1>Traçar Rota Marítima</h1>

    <form id="routeForm">
        <label for="origin">Porto de Origem:</label>
        <select name="origin" id="origin">
            {% for port, coords in ports.items() %}
                <option value="{{ port }}">{{ port }}</option>
            {% endfor %}
        </select>
        
        <label for="destination">Porto de Destino:</label>
        <select name="destination" id="destination">
            {% for port, coords in ports.items() %}
                <option value="{{ port }}">{{ port }}</option>
            {% endfor %}
        </select>
        
        <button type="submit">Traçar Rota</button>
    </form>

    <h2 id="distanceText"></h2>

    <div id="mapid"></div>

    <script>
        // Inicialização do mapa (apenas uma vez)
        var map = L.map('mapid').setView([-23.99049, -46.10390], 8); // Posição inicial do mapa
    
        // Carregar o OpenStreetMap com o Leaflet
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);
        
        // Camada da rota (será atualizada dinamicamente)
        var routeLayer = L.layerGroup().addTo(map);
    
        // Função para traçar a rota
        $("#routeForm").submit(function(event) {
            event.preventDefault();  // Evitar recarregamento da página
    
            var origin = $("#origin").val();
            var destination = $("#destination").val();
    
            // Enviar os dados do formulário para o backend Flask
            $.post({
                url: "/",
                data: {
                    origin: origin,
                    destination: destination
                },
                success: function(response) {
                    var coordinates = response.coordinates;
                    var length_nautical = response.length_nautical;
                    var length_km = response.length_km;
                    var duration_hours = response.duration_hours;
                    // Limpar a camada da rota anterior
                    routeLayer.clearLayers();
    
                    // Adicionar a linha da nova rota na camada
                    L.polyline(coordinates, {color: 'blue', weight: 3}).addTo(routeLayer);
    
                    // Mostrar a distância
                    $("#distanceText").html("Distância: " + length_nautical.toFixed(2) + " milhas náuticas / " + length_km.toFixed(2) + " km | Tempo de Viagem: "+duration_hours.toFixed(2) + " horas");
    
                    // Ajustar o mapa para exibir a rota corretamente
                    map.fitBounds(routeLayer.getBounds());
                },
                dataType: "json"
            });
        });
    </script>
</body>
</html>